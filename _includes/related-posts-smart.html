<!-- Smart Related Posts Component - Top 3 Tag Matches -->
{% if page.id and page.tags %}
  {% assign current_tags = page.tags | sort %}
  {% assign current_tag_count = current_tags | size %}
  
  {% if current_tag_count > 0 %}
    {% assign related_posts = '' | split: '' %}
    
    {% comment %}<!-- Find all posts with at least 1 matching tag and score them -->{% endcomment %}
    {% for post in site.posts %}
      {% if post.url != page.url and post.tags %}
        {% assign post_tags = post.tags | sort %}
        {% assign matching_tags = 0 %}
        
        {% comment %}<!-- Count matching tags -->{% endcomment %}
        {% for tag in current_tags %}
          {% if post_tags contains tag %}
            {% assign matching_tags = matching_tags | plus: 1 %}
          {% endif %}
        {% endfor %}
        
        {% comment %}<!-- Only include if at least 1 tag matches -->{% endcomment %}
        {% if matching_tags > 0 %}
          {% comment %}<!-- Create sortable score: pad matching_tags to 2 digits for proper sorting -->{% endcomment %}
          {% if matching_tags < 10 %}
            {% assign score_padded = matching_tags | prepend: '0' %}
          {% else %}
            {% assign score_padded = matching_tags %}
          {% endif %}
          {% assign post_with_score = score_padded | append: '|' | append: post.url | append: '|' | append: matching_tags %}
          {% assign related_posts = related_posts | push: post_with_score %}
        {% endif %}
      {% endif %}
    {% endfor %}
  
    {% comment %}<!-- Display related posts if found -->{% endcomment %}
    {% if related_posts.size > 0 %}
      <aside class="related-posts">
        <div class="related-posts__container">
          <h3 class="related-posts__title">
            <i class="fas fa-lightbulb"></i> Related Power Platform Tips
          </h3>
          <p class="related-posts__subtitle">
            Posts with similar tags â€“ continue your learning journey
          </p>
          
          <div class="related-posts__grid">
            {% comment %}<!-- Sort by matching tags count (highest first) and limit to 3 -->{% endcomment %}
            {% assign sorted_related = related_posts | sort | reverse %}
            {% assign display_count = 0 %}
            {% assign max_display = 3 %}
          
          {% for related_item in sorted_related %}
            {% if display_count < max_display %}
              {% assign item_parts = related_item | split: '|' %}
              {% assign post_url = item_parts[1] %}
              {% assign match_count = item_parts[2] %}
              
              {% comment %}<!-- Find the actual post -->{% endcomment %}
              {% assign related_post = site.posts | where: "url", post_url | first %}
              
              {% if related_post %}
                <article class="related-post-card">
                  <div class="related-post-card__match">
                    <span class="related-post-card__match-badge">
                      {{ match_count }} matching tag{% if match_count != "1" %}s{% endif %}
                    </span>
                  </div>
                  
                  <h4 class="related-post-card__title">
                    <a href="{{ related_post.url | relative_url }}">
                      {{ related_post.title | truncate: 80 }}
                    </a>
                  </h4>
                  
                  {% if related_post.excerpt %}
                    <p class="related-post-card__excerpt">
                      {{ related_post.excerpt | strip_html | truncate: 120 }}
                    </p>
                  {% endif %}
                  
                  <div class="related-post-card__meta">
                    {% if related_post.date %}
                      <span class="related-post-card__date">
                        <i class="far fa-calendar-alt"></i>
                        {{ related_post.date | date: "%b %d, %Y" }}
                      </span>
                    {% endif %}
                    
                    <span class="related-post-card__read-time">
                      <i class="far fa-clock"></i>
                      {% assign words = related_post.content | number_of_words %}
                      {% assign minutes = words | divided_by: 200 %}
                      {% if minutes == 0 %}{% assign minutes = 1 %}{% endif %}
                      {{ minutes }} min read
                    </span>
                  </div>
                  
                  <div class="related-post-card__tags">
                    {% comment %}<!-- Show matching tags (up to 4) -->{% endcomment %}
                    {% assign shown_tags = 0 %}
                    {% for tag in current_tags %}
                      {% if related_post.tags contains tag and shown_tags < 4 %}
                        <span class="related-post-card__tag related-post-card__tag--match">
                          {{ tag }}
                        </span>
                        {% assign shown_tags = shown_tags | plus: 1 %}
                      {% endif %}
                    {% endfor %}
                  </div>
                  
                  <a href="{{ related_post.url | relative_url }}" class="related-post-card__link">
                    Read More <i class="fas fa-arrow-right"></i>
                  </a>
                </article>
                
                {% assign display_count = display_count | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
        
        {% if display_count == 0 %}
          <p class="related-posts__empty">
            No related posts found. <a href="/posts/">Explore all tips</a>
          </p>
        {% endif %}
      </div>
    </aside>
    {% endif %}
  {% endif %}
{% endif %}
