<!-- Smart Related Posts Component - 90%+ Tag Match -->
{% if page.id and page.tags %}
  {% assign current_tags = page.tags | sort %}
  {% assign current_tag_count = current_tags | size %}
  
  {% if current_tag_count > 0 %}
    {% assign related_posts = '' | split: '' %}
    {% assign min_match_percentage = 90 %}
    
    {% comment %}<!-- Calculate minimum tags needed for 90% match -->{% endcomment %}
    {% assign min_tags_required = current_tag_count | times: min_match_percentage | divided_by: 100.0 | ceil %}
    
    {% comment %}<!-- Find posts with high tag overlap -->{% endcomment %}
    {% for post in site.posts %}
      {% if post.url != page.url %}
        {% assign post_tags = post.tags | sort %}
        {% assign matching_tags = 0 %}
        
        {% comment %}<!-- Count matching tags -->{% endcomment %}
        {% for tag in current_tags %}
          {% if post_tags contains tag %}
            {% assign matching_tags = matching_tags | plus: 1 %}
          {% endif %}
        {% endfor %}
        
        {% comment %}<!-- Calculate match percentage -->{% endcomment %}
        {% assign match_percentage = matching_tags | times: 100 | divided_by: current_tag_count %}
        
        {% comment %}<!-- Add to related posts if meets threshold -->{% endcomment %}
        {% if match_percentage >= min_match_percentage %}
          {% assign post_with_score = post.url | append: '|' | append: match_percentage | append: '|' | append: matching_tags %}
          {% assign related_posts = related_posts | push: post_with_score %}
        {% endif %}
      {% endif %}
    {% endfor %}
  
    {% comment %}<!-- Display related posts if found -->{% endcomment %}
    {% if related_posts.size > 0 %}
      <aside class="related-posts">
        <div class="related-posts__container">
          <h3 class="related-posts__title">
            <i class="fas fa-lightbulb"></i> Related Power Platform Tips
          </h3>
          <p class="related-posts__subtitle">
            Based on similar topics and tags â€“ continue your learning journey
          </p>
          
          <div class="related-posts__grid">
            {% comment %}<!-- Sort by match percentage (highest first) and limit to 4 -->{% endcomment %}
            {% assign sorted_related = related_posts | sort | reverse %}
            {% assign display_count = 0 %}
            {% assign max_display = 4 %}
          
          {% for related_item in sorted_related %}
            {% if display_count < max_display %}
              {% assign item_parts = related_item | split: '|' %}
              {% assign post_url = item_parts[0] %}
              {% assign match_percent = item_parts[1] %}
              {% assign match_count = item_parts[2] %}
              
              {% comment %}<!-- Find the actual post -->{% endcomment %}
              {% assign related_post = site.posts | where: "url", post_url | first %}
              
              {% if related_post %}
                <article class="related-post-card">
                  <div class="related-post-card__match">
                    <span class="related-post-card__match-badge">
                      {{ match_percent }}% match
                    </span>
                  </div>
                  
                  <h4 class="related-post-card__title">
                    <a href="{{ related_post.url | relative_url }}">
                      {{ related_post.title | truncate: 80 }}
                    </a>
                  </h4>
                  
                  {% if related_post.excerpt %}
                    <p class="related-post-card__excerpt">
                      {{ related_post.excerpt | strip_html | truncate: 120 }}
                    </p>
                  {% endif %}
                  
                  <div class="related-post-card__meta">
                    {% if related_post.date %}
                      <span class="related-post-card__date">
                        <i class="far fa-calendar-alt"></i>
                        {{ related_post.date | date: "%b %d, %Y" }}
                      </span>
                    {% endif %}
                    
                    {% if related_post.read_time %}
                      <span class="related-post-card__read-time">
                        <i class="far fa-clock"></i>
                        {% assign words = related_post.content | number_of_words %}
                        {% assign minutes = words | divided_by: 200 %}
                        {% if minutes == 0 %}{% assign minutes = 1 %}{% endif %}
                        {{ minutes }} min read
                      </span>
                    {% endif %}
                  </div>
                  
                  <div class="related-post-card__tags">
                    {% comment %}<!-- Show matching tags -->{% endcomment %}
                    {% for tag in current_tags limit: 3 %}
                      {% if related_post.tags contains tag %}
                        <span class="related-post-card__tag related-post-card__tag--match">
                          {{ tag }}
                        </span>
                      {% endif %}
                    {% endfor %}
                  </div>
                  
                  <a href="{{ related_post.url | relative_url }}" class="related-post-card__link">
                    Read More <i class="fas fa-arrow-right"></i>
                  </a>
                </article>
                
                {% assign display_count = display_count | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
        
        {% if display_count == 0 %}
          <p class="related-posts__empty">
            No closely related posts found. <a href="/posts/">Explore all tips</a>
          </p>
        {% endif %}
      </div>
    </aside>
    {% endif %}
  {% endif %}
{% endif %}
