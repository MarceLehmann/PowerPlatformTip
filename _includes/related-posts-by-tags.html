{% assign current_tags = page.tags | default: [] %}
{% assign related = site.posts | where_exp: "post", "post.id != page.id and post.hidden != true" %}

{% assign related_with_score = related | map: "post" %}
{% assign scored_posts = [] %}

{% for post in related %}
  {% assign score = 0 %}
  {% for tag in post.tags %}
    {% if current_tags contains tag %}
      {% assign score = score | plus: 1 %}
    {% endif %}
  {% endfor %}
  {% if score > 0 %}
    {% assign scored_posts = scored_posts | push: post | sort: "score" %}
    {% assign post = post | merge: { "score": score } %}
  {% endif %}
{% endfor %}

{% assign sorted = scored_posts | sort: "score" | reverse %}
{% assign top_related = sorted | slice: 0, 3 %}

{% if top_related.size > 0 %}
<div class="page__related">
  <h2 class="page__related-title">{{ site.data.ui-text[site.locale].related_label | default: "You May Also Enjoy" }}</h2>
  <div class="grid__wrapper">
    {% for post in top_related %}
      {% include archive-single.html type="grid" %}
    {% endfor %}
  </div>
</div>
{% endif %}
