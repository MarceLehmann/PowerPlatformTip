{% assign current_tags = page.tags | default: [] %}
{% assign related = site.posts | where_exp: "post", "post.id != page.id" %}
{% unless page.hidden == false %}
  {% assign related = related | where_exp: "post", "post.hidden != true" %}
{% endunless %}

{% assign posts_with_common_tags = "" | split: "" %}

{% for post in related %}
  {% assign has_common_tag = false %}
  {% for tag in post.tags %}
    {% if current_tags contains tag %}
      {% assign has_common_tag = true %}
      {% break %}
    {% endif %}
  {% endfor %}
  {% if has_common_tag %}
    {% assign posts_with_common_tags = posts_with_common_tags | push: post %}
  {% endif %}
{% endfor %}

{% assign top_related = posts_with_common_tags | slice: 0, 3 %}

{% if top_related.size > 0 %}
<div class="page__related">
  <h2 class="page__related-title">{{ site.data.ui-text[site.locale].related_label | default: "You May Also Enjoy" }}</h2>
  <div class="grid__wrapper">
    {% for post in top_related %}
      {% include archive-single.html type="grid" %}
    {% endfor %}
  </div>
</div>
{% endif %}
