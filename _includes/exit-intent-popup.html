<!-- ============================================
     EXIT-INTENT POPUP
     ============================================
     
     Captures leaving visitors with targeted offer
     when mouse moves towards browser close/back.
     
     Features:
     - Mouse movement detection
     - Mobile: Show after 30s + scroll
     - Cookie: Once per 7 days
     - Multiple offers support
     - A/B testing ready
     ============================================ -->

<div class="exit-intent" id="exit-intent-popup" style="display: none;">
  <div class="exit-intent__overlay"></div>
  
  <div class="exit-intent__modal">
    <!-- Close Button -->
    <button class="exit-intent__close" id="exit-intent-close" aria-label="Close popup">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <div class="exit-intent__content">
      
      <!-- Icon/Emoji -->
      <div class="exit-intent__icon">
        ‚úã
      </div>

      <!-- Headline -->
      <h2 class="exit-intent__headline">
        Wait! Before you go...
      </h2>

      <!-- Subheadline -->
      <p class="exit-intent__subheadline">
        Join <strong>4,000+</strong> Power Platform professionals getting weekly tips & tricks
      </p>

      <!-- Benefits -->
      <ul class="exit-intent__benefits">
        <li class="exit-intent__benefit">
          <svg class="exit-intent__check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>Weekly Power Apps & Power Automate tips</span>
        </li>
        <li class="exit-intent__benefit">
          <svg class="exit-intent__check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>Exclusive tutorials & templates</span>
        </li>
        <li class="exit-intent__benefit">
          <svg class="exit-intent__check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>No spam, unsubscribe anytime</span>
        </li>
      </ul>

      <!-- Bonus Offer (Optional) -->
      <div class="exit-intent__bonus">
        <span class="exit-intent__bonus-badge">üéÅ Bonus</span>
        <span class="exit-intent__bonus-text">Get my <strong>Power Apps Cheat Sheet</strong> instantly</span>
      </div>

      <!-- Form -->
      <form class="exit-intent__form" id="exit-intent-form">
        <div class="exit-intent__input-wrapper">
          <input type="email" 
                 name="email" 
                 id="exit-intent-email"
                 class="exit-intent__input"
                 placeholder="Enter your email address"
                 required
                 autocomplete="email">
          
          <!-- Honeypot -->
          <input type="text" 
                 name="hp_field" 
                 class="exit-intent__honeypot"
                 tabindex="-1"
                 autocomplete="off">
        </div>

        <button type="submit" class="exit-intent__button">
          <svg class="exit-intent__button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
          <span>Send Me Weekly Tips</span>
        </button>
      </form>

      <!-- Social Proof -->
      <div class="exit-intent__social-proof">
        <div class="exit-intent__avatars">
          <img src="{{ '/assets/images/avatar-1.jpg' | relative_url }}" alt="Subscriber" loading="lazy">
          <img src="{{ '/assets/images/avatar-2.jpg' | relative_url }}" alt="Subscriber" loading="lazy">
          <img src="{{ '/assets/images/avatar-3.jpg' | relative_url }}" alt="Subscriber" loading="lazy">
          <span class="exit-intent__avatars-more">+4,000</span>
        </div>
        <p class="exit-intent__social-text">
          Join thousands of Power Platform professionals
        </p>
      </div>

      <!-- Privacy Notice -->
      <p class="exit-intent__privacy">
        <svg class="exit-intent__privacy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
        I respect your privacy. Unsubscribe anytime. 
        <a href="{{ '/privacy-policy/' | relative_url }}" class="exit-intent__privacy-link">Privacy Policy</a>
      </p>

    </div>

    <!-- Success State (Hidden) -->
    <div class="exit-intent__success" id="exit-intent-success" style="display: none;">
      <div class="exit-intent__success-icon">
        üéâ
      </div>
      <h3 class="exit-intent__success-title">You're all set!</h3>
      <p class="exit-intent__success-text">
        Check your inbox for a confirmation email.<br>
        I've also sent you the <strong>Power Apps Cheat Sheet</strong>.
      </p>
      <button class="exit-intent__success-button" id="exit-intent-success-close">
        Continue Reading
      </button>
    </div>

  </div>
</div>

<!-- Exit Intent JavaScript -->
<script>
(function() {
  'use strict';

  // Configuration
  const config = {
    cookieName: 'exit_intent_shown',
    cookieDays: 7,
    exitThreshold: 20, // pixels from top
    mobileDelay: 30000, // 30 seconds
    mobileScrollPercent: 50, // 50% scroll
    debug: false
  };

  // State
  let exitIntentShown = false;
  let startTime = Date.now();
  let maxScroll = 0;

  // Elements
  const popup = document.getElementById('exit-intent-popup');
  const closeBtn = document.getElementById('exit-intent-close');
  const form = document.getElementById('exit-intent-form');
  const successDiv = document.getElementById('exit-intent-success');
  const successCloseBtn = document.getElementById('exit-intent-success-close');
  const overlay = popup.querySelector('.exit-intent__overlay');
  const content = popup.querySelector('.exit-intent__content');
  const emailInput = document.getElementById('exit-intent-email');
  const honeypot = form.querySelector('input[name="hp_field"]');

  // Check if already shown
  if (getCookie(config.cookieName)) {
    if (config.debug) console.log('Exit intent already shown');
    return;
  }

  // Desktop: Mouse leave detection
  if (!isMobile()) {
    document.addEventListener('mouseleave', function(e) {
      if (e.clientY < config.exitThreshold && !exitIntentShown) {
        showExitIntent();
      }
    });
  }
  // Mobile: Time + Scroll detection
  else {
    // Time-based trigger
    setTimeout(function() {
      if (!exitIntentShown && maxScroll >= config.mobileScrollPercent) {
        showExitIntent();
      }
    }, config.mobileDelay);

    // Scroll tracking
    window.addEventListener('scroll', function() {
      const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
      maxScroll = Math.max(maxScroll, scrollPercent);
    });
  }

  // Show popup
  function showExitIntent() {
    if (exitIntentShown) return;
    
    exitIntentShown = true;
    popup.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Animation
    setTimeout(function() {
      popup.classList.add('exit-intent--visible');
    }, 10);

    // Track event
    trackEvent('Exit Intent', 'Shown', window.location.pathname);

    // Focus email input
    setTimeout(function() {
      emailInput.focus();
    }, 300);
  }

  // Close popup
  function closeExitIntent() {
    popup.classList.remove('exit-intent--visible');
    setTimeout(function() {
      popup.style.display = 'none';
      document.body.style.overflow = '';
    }, 300);

    // Set cookie
    setCookie(config.cookieName, 'true', config.cookieDays);

    // Track close
    trackEvent('Exit Intent', 'Closed', 'User Action');
  }

  // Close button
  closeBtn.addEventListener('click', closeExitIntent);
  successCloseBtn.addEventListener('click', closeExitIntent);

  // Overlay click
  overlay.addEventListener('click', closeExitIntent);

  // ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && exitIntentShown) {
      closeExitIntent();
    }
  });

  // Form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Check honeypot
    if (honeypot && honeypot.value !== '') {
      if (config.debug) console.log('Bot detected');
      return;
    }

    const email = emailInput.value.trim();
    if (!email) return;

    // Disable form
    const button = form.querySelector('button[type="submit"]');
    const originalButtonHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span>Subscribing...</span>';

    try {
      // Send to Mailchimp or your email service
      // TODO: Replace with actual API call
      await simulateSubscribe(email);

      // Show success
      content.style.display = 'none';
      successDiv.style.display = 'block';

      // Track conversion
      trackEvent('Exit Intent', 'Subscribed', email);
      trackConversion('Exit Intent Subscribe', 1);

      // Save to localStorage
      saveSubscription(email, 'Exit Intent');

    } catch (error) {
      console.error('Error:', error);
      alert('Something went wrong. Please try again.');
      button.disabled = false;
      button.innerHTML = originalButtonHTML;
    }
  });

  // Simulate subscription (replace with actual API)
  function simulateSubscribe(email) {
    return new Promise((resolve) => {
      setTimeout(() => {
        if (config.debug) console.log('Subscribed:', email);
        resolve();
      }, 1000);
    });
  }

  // Helper: Check if mobile
  function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
  }

  // Helper: Cookies
  function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = name + '=' + value + ';expires=' + date.toUTCString() + ';path=/';
  }

  function getCookie(name) {
    const value = '; ' + document.cookie;
    const parts = value.split('; ' + name + '=');
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  // Helper: Track events
  function trackEvent(category, action, label) {
    // Google Analytics 4
    if (typeof gtag !== 'undefined') {
      gtag('event', action, {
        event_category: category,
        event_label: label
      });
    }

    // Facebook Pixel
    if (typeof fbq !== 'undefined') {
      fbq('trackCustom', category + '_' + action, { label: label });
    }

    if (config.debug) console.log('Event:', category, action, label);
  }

  // Helper: Track conversion
  function trackConversion(event, value) {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'generate_lead', {
        event_category: 'Exit Intent',
        event_label: event,
        value: value
      });
    }

    if (typeof fbq !== 'undefined') {
      fbq('track', 'Lead', {
        content_name: event,
        value: value
      });
    }
  }

  // Helper: Save subscription
  function saveSubscription(email, source) {
    const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
    subscriptions.push({
      email: email,
      source: source,
      date: new Date().toISOString(),
      url: window.location.pathname
    });
    localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
  }

})();
</script>
